<html>
  <head>
    <!-- Load libraries -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>

    <style>
      .hp-gui {
        position: absolute;
        font-family: Arial, sans-serif;
        padding: 10px;
        border-radius: 5px;
        color: white;
      }
      .hp-agentA {
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 255, 0.5); /* Blue color */
        display: none;
      }
      .hp-agentB {
        top: 10px;
        right: 10px;
        background-color: rgba(255, 0, 0, 0.5); /* Red color */
        display: none;
      }
      .armor-agentA {
        top: 50px; /* Position below the HP bar */
        left: 10px;
        background-color: rgba(0, 0, 128, 0.5); /* Dark blue color */
        display: none;
      }

      .armor-agentB {
        top: 50px; /* Position below the HP bar */
        right: 10px;
        background-color: rgba(128, 0, 0, 0.5); /* Dark red color */
        display: none;
      }
      .game-over {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-family: Arial, sans-serif;
  font-size: 2em;
  color: yellow;
  background-color: rgba(0, 0, 0, 0.7);
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  display: none; /* Hidden by default */
}
      
    </style>

    <script>
      let target_visible = {
        charaA: false,
        charaB: false,
      };

      AFRAME.registerComponent("target-events", {
        init: function () {
          let el = this.el;

          el.addEventListener("targetFound", function () {
            target_visible[el.id] = true;
            console.log(el.id + " found");
          });

          el.addEventListener("targetLost", function () {
            target_visible[el.id] = false;
            console.log(el.id + " lost");
          });
        },
      });

      AFRAME.registerComponent("draw-line", {
        init: function () {
          // References to the DOM/HTML elements
          this.Agent1 = document.querySelector("#charaAModel");
          this.Agent2 = document.querySelector("#charaBModel");
          this.ak47Model = document.querySelector("#ak47Model");
          this.famasF1Model = document.querySelector("#famasF1Model");
          this.pp19BizonModel = document.querySelector("#pp19BizonModel");
          this.m14Model = document.querySelector("#m14Model");
          this.sksType56Model = document.querySelector("#sksType56Model");
          this.vz61SkorpionModel = document.querySelector("#vz61SkorpionModel");
          this.hpDisplayA = document.querySelector("#hp-display-A");
          this.hpDisplayB = document.querySelector("#hp-display-B");
          this.armorDisplayA = document.querySelector("#armor-display-A");
          this.armorDisplayB = document.querySelector("#armor-display-B");
          this.dieEffectA = document.querySelector("#dieEffectA");
          this.dieEffectB = document.querySelector("#dieEffectB");
          this.gameOverDisplay = document.querySelector("#game-over");
    this.winnerDisplay = document.querySelector("#winner");

          this.stats = {
            charaA: { hp: 100, armor: 100 },
            charaB: { hp: 100, armor: 100 },
          };

          // Flags to track if damage has been applied
          this.ak47Tracked = false;
          this.famasF1Tracked = false;
          this.pp19BizonTracked = false;
          this.m14Tracked = false;
          this.sksType56Tracked = false;
          this.vz61SkorpionTracked = false;
        },

        tick: function () {
          // Damage values for each weapon
          const DAMAGE_VALUES = {
            ak_47: 28,
            famas_f1: 22,
            pp_19_bizon: 15,
            m14: 100,
            sks_type_56: 24,
            vz61_skorpion: 14,
          };


          // Function to apply damage
          const applyDamage = (character, damage) => {
            if (character.armor > 0) {
              let remainingDamage = damage - character.armor;
              character.armor = Math.max(0, character.armor - damage);
              if (remainingDamage > 0) {
                character.hp = Math.max(0, character.hp - remainingDamage);
              }
            } else {
              character.hp = Math.max(0, character.hp - damage);
            }
          };

          // Handle visibility of AgentA and weapon detection
          if (target_visible["charaA"]) {
            this.Agent1.object3D.visible = true;

            if (target_visible["famas_f1"]) {
              this.famasF1Model.object3D.visible = true;
              this.Agent1.setAttribute(
                "animation-mixer",
                "clip: tools_preview"
              );

              if (!this.famasF1Tracked) {
                applyDamage(this.stats.charaB, DAMAGE_VALUES.famas_f1);
                this.famasF1Tracked = true;
              }
            } else if (target_visible["pp_19_bizon"]) {
              this.pp19BizonModel.object3D.visible = true;
              this.Agent1.setAttribute(
                "animation-mixer",
                "clip: tools_preview"
              );

              if (!this.pp19BizonTracked) {
                applyDamage(this.stats.charaB, DAMAGE_VALUES.pp_19_bizon);
                this.pp19BizonTracked = true;
              }
            } else if (target_visible["ak_47"]) {
              this.ak47Model.object3D.visible = true;
              this.Agent1.setAttribute(
                "animation-mixer",
                "clip: tools_preview"
              );

              if (!this.ak47Tracked) {
                applyDamage(this.stats.charaB, DAMAGE_VALUES.ak_47);
                this.ak47Tracked = true;
              }
            } else {
              // No weapon detected, reset to "eye-test" pose
              this.famasF1Model.object3D.visible = false;
              this.pp19BizonModel.object3D.visible = false;
              this.ak47Model.object3D.visible = false;
              this.Agent1.setAttribute("animation-mixer", "clip: eye_test");
              this.famasF1Tracked = false;
              this.pp19BizonTracked = false;
              this.ak47Tracked = false;
            }
          } else {
            this.Agent1.object3D.visible = false;
            this.famasF1Model.object3D.visible = false;
            this.pp19BizonModel.object3D.visible = false;
            this.ak47Model.object3D.visible = false;
          }

          // Handle visibility of AgentB and weapon detection
          if (target_visible["charaB"]) {
            this.Agent2.object3D.visible = true;

            if (target_visible["m14"]) {
              this.m14Model.object3D.visible = true;
              this.Agent2.setAttribute(
                "animation-mixer",
                "clip: tools_preview"
              );

              if (!this.m14Tracked) {
                applyDamage(this.stats.charaA, DAMAGE_VALUES.m14);
                this.m14Tracked = true;
              }
            } else if (target_visible["sks_type_56"]) {
              this.sksType56Model.object3D.visible = true;
              this.Agent2.setAttribute(
                "animation-mixer",
                "clip: tools_preview"
              );

              if (!this.sksType56Tracked) {
                applyDamage(this.stats.charaA, DAMAGE_VALUES.sks_type_56);
                this.sksType56Tracked = true;
              }
            } else if (target_visible["vz61_skorpion"]) {
              this.vz61SkorpionModel.object3D.visible = true;
              this.Agent2.setAttribute(
                "animation-mixer",
                "clip: tools_preview"
              );

              if (!this.vz61SkorpionTracked) {
                applyDamage(this.stats.charaA, DAMAGE_VALUES.vz61_skorpion);
                this.vz61SkorpionTracked = true;
              }
            } else {
              // No weapon detected, reset to "eye-test" pose
              this.m14Model.object3D.visible = false;
              this.sksType56Model.object3D.visible = false;
              this.vz61SkorpionModel.object3D.visible = false;
              this.Agent2.setAttribute("animation-mixer", "clip: eye_test");
              this.m14Tracked = false;
              this.sksType56Tracked = false;
              this.vz61SkorpionTracked = false;
            }
          } else {
            this.Agent2.object3D.visible = false;
            this.m14Model.object3D.visible = false;
            this.sksType56Model.object3D.visible = false;
            this.vz61SkorpionModel.object3D.visible = false;
          }

          if (target_visible["charaA"] && target_visible["charaB"]) {
            let positionA = new THREE.Vector3();
            let positionB = new THREE.Vector3();

            this.Agent1.object3D.getWorldPosition(positionA);
            this.Agent2.object3D.getWorldPosition(positionB);

            this.Agent1.object3D.lookAt(positionB);
            this.Agent2.object3D.lookAt(positionA);
          }

          // Update HP and Armor displays
          if (target_visible["charaA"]) {
            this.hpDisplayA.style.display = "block";
            this.hpDisplayA.innerHTML = `Agent A HP: ${this.stats.charaA.hp}`;
            this.armorDisplayA.style.display = "block";
            this.armorDisplayA.innerHTML = `Agent A Armor: ${this.stats.charaA.armor}`;
          } else {
            this.hpDisplayA.style.display = "none";
            this.armorDisplayA.style.display = "none";
          }

          if (target_visible["charaB"]) {
            this.hpDisplayB.style.display = "block";
            this.hpDisplayB.innerHTML = `Agent B HP: ${this.stats.charaB.hp}`;
            this.armorDisplayB.style.display = "block";
            this.armorDisplayB.innerHTML = `Agent B Armor: ${this.stats.charaB.armor}`;
          } else {
            this.hpDisplayB.style.display = "none";
            this.armorDisplayB.style.display = "none";
          }

          // Handle death and die effects
          if (this.stats.charaA.hp <= 0) {
      if (!this.dieEffectA.object3D.visible) {
        this.dieEffectA.object3D.visible = true;
        this.dieEffectA.object3D.position.copy(
          this.Agent1.object3D.position
        );
        this.Agent1.object3D.visible = false;
        this.showGameOver("Agent B Wins!");
      }
    }

    if (this.stats.charaB.hp <= 0) {
      if (!this.dieEffectB.object3D.visible) {
        this.dieEffectB.object3D.visible = true;
        this.dieEffectB.object3D.position.copy(
          this.Agent2.object3D.position
        );
        this.Agent2.object3D.visible = false;
        this.showGameOver("Agent A Wins!");
      }
    }
  },
  showGameOver: function (winnerText) {
    this.gameOverDisplay.style.display = "block";
    this.winnerDisplay.innerHTML = winnerText;
  }
      });
    </script>
  </head>

  <body>
    <a-scene
      mindar-image="imageTargetSrc: mind/targets.mind; maxTrack: 8"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" id="charaA" target-events>
        <a-gltf-model
          id="charaAModel"
          src="model/fbi_cs2_agent.glb"
          position="0 0.5 0"
          scale="0.5 0.5 0.5"
          rotation="90 0 0"
          animation-mixer="clip: eye_test"
        >
        <a-gltf-model id="ak47Model"src="model/ak_47.glb" position="-0.1 1.45 0.4" scale="0.4 0.4 0.4" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model id="famasF1Model"src="model/famas_f1.glb" position="-0.1 1.35 0.4" scale="0.4 0.4 0.4" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model id="pp19BizonModel"src="model/pp_19_bizon.glb" position="-0.15 1.35 0.4" scale="0.5 0.5 0.5" rotation="0 180 0"></a-gltf-model>

          <a-gltf-model
            id="dieEffectA"
            src="model/timeframe_explosion.glb"
            position="0 0.5 0"
            scale="0.25 0.25 0.25"
            visible="false"
            animation-mixer="clip: Explosion"
          >
          </a-gltf-model>
        </a-gltf-model>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1" id="charaB" target-events>
        <a-gltf-model
          id="charaBModel"
          src="model/balkan_cs2_agent.glb"
          position="0 0.5 0"
          scale="0.5 0.5 0.5"
          rotation="90 0 0"
          animation-mixer="clip: tools_preview"
        >
        <a-gltf-model id="m14Model"src="model/m14.glb" position="-0.1 1 0.3" scale="0.6 0.6 0.6" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model id="sksType56Model"src="model/sks_type_56.glb" position="-0.1 1.08 0.4" scale="0.4 0.4 0.4" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model id="vz61SkorpionModel"src="model/vz61_skorpion.glb" position="-0.1 1.15 0.15" scale="0.2 0.2 0.2" rotation="0 180 0"></a-gltf-model>

          <a-gltf-model
            id="dieEffectB"
            src="model/timeframe_explosion.glb"
            position="0 0.5 0"
            scale="0.25 0.25 0.25"
            visible="false"
            animation-mixer="clip: Explosion"
          >
          </a-gltf-model>
        </a-gltf-model>
      </a-entity>

      <a-entity
        mindar-image-target="targetIndex: 2"
        id="ak_47"
        target-events
      ></a-entity>

      <a-entity
        mindar-image-target="targetIndex: 3"
        id="famas_f1"
        target-events
      ></a-entity>

      <a-entity
        mindar-image-target="targetIndex: 4"
        id="pp_19_bizon"
        target-events
      ></a-entity>

      <a-entity
        mindar-image-target="targetIndex: 5"
        id="m14"
        target-events
      ></a-entity>

      <a-entity
        mindar-image-target="targetIndex: 6"
        id="sks_type_56"
        target-events
      ></a-entity>

      <a-entity
        mindar-image-target="targetIndex: 7"
        id="vz61_skorpion"
        target-events
      ></a-entity>

      <!-- HP Displays -->
      <div id="hp-display-A" class="hp-gui hp-agentA">Agent A HP: 100</div>
      <div id="hp-display-B" class="hp-gui hp-agentB">Agent B HP: 100</div>

      <!-- Armor Displays -->
      <div id="armor-display-A" class="hp-gui armor-agentA">
        Agent A Armor: 100
      </div>
      <div id="armor-display-B" class="hp-gui armor-agentB">
        Agent B Armor: 100
      </div>

      <div id="game-over" class="game-over">
        GAME OVER<br>
        <span id="winner"></span>
      </div>

      <a-entity draw-line></a-entity>
    </a-scene>
  </body>
</html>
